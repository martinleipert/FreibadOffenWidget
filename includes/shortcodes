<?pphp

// Shortcode for embedding the status setting form in a password-protected page
function pool_status_settings_shortcode() {
    // Check if the form is submitted
    if (isset($_POST['pool_status_nonce']) && wp_verify_nonce($_POST['pool_status_nonce'], 'pool_status_settings')) {
        $manual_status = sanitize_text_field($_POST['manual_status']);
        $manual_temp = sanitize_text_field($_POST['manual_temp']);
        $api_key = sanitize_text_field($_POST['pool_api_key']);
        $city_id = sanitize_text_field($_POST['pool_city_id']);
        $opening_hours = array();

        foreach (array('monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday') as $day) {
            $opening_hours[$day] = sanitize_text_field($_POST['pool_opening_hours_' . $day]);
        }

        update_option('pool_manual_status', $manual_status);
        update_option('pool_manual_temp', $manual_temp);
        update_option('pool_api_key', $api_key);
        update_option('pool_city_id', $city_id);

        foreach ($opening_hours as $day => $hours) {
            update_option('pool_opening_hours_' . $day, $hours);
        }

        log_manual_change('status', $manual_status);
        log_manual_change('temperature', $manual_temp);

        echo '<div class="updated"><p>' . __('Settings saved.', 'pool-status-widget') . '</p></div>';
    }

    // Get current settings
    $manual_status = get_option('pool_manual_status', '');
    $manual_temp = get_option('pool_manual_temp', '');
    $api_key = get_option('pool_api_key', '');
    $city_id = get_option('pool_city_id', '');
    $opening_hours = array();
    foreach (array('monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday') as $day) {
        $opening_hours[$day] = get_option('pool_opening_hours_' . $day, '');
    }

    ob_start();
    ?>
    <div class="wrap">
        <h1><?php _e('Pool Status Settings', 'pool-status-widget'); ?></h1>
        <form method="post" action="">
            <?php wp_nonce_field('pool_status_settings', 'pool_status_nonce'); ?>
            <table class="form-table">
                <tr>
                    <th scope="row"><label for="manual_status"><?php _e('Manual Status', 'pool-status-widget'); ?></label></th>
                    <td>
                        <select id="manual_status" name="manual_status">
                            <option value="" <?php selected($manual_status, ''); ?>><?php _e('Auto', 'pool-status-widget'); ?></option>
                            <option value="Open" <?php selected($manual_status, 'Open'); ?>><?php _e('Open', 'pool-status-widget'); ?></option>
                            <option value="Closed" <?php selected($manual_status, 'Closed'); ?>><?php _e('Closed', 'pool-status-widget'); ?></option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th scope="row"><label for="manual_temp"><?php _e('Manual Water Temperature', 'pool-status-widget'); ?></label></th>
                    <td><input name="manual_temp" type="number" step="0.1" id="manual_temp" value="<?php echo esc_attr($manual_temp); ?>" class="regular-text"></td>
                </tr>
                <tr>
                    <th scope="row"><label for="pool_api_key"><?php _e('API Key', 'pool-status-widget'); ?></label></th>
                    <td><input name="pool_api_key" type="text" id="pool_api_key" value="<?php echo esc_attr($api_key); ?>" class="regular-text"></td>
                </tr>
                <tr>
                    <th scope="row"><label for="pool_city_id"><?php _e('City ID', 'pool-status-widget'); ?></label></th>
                    <td><input name="pool_city_id" type="text" id="pool_city_id" value="<?php echo esc_attr($city_id); ?>" class="regular-text"></td>
                </tr>
                <?php
                foreach (array('monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday') as $day) {
                    ?>
                    <tr>
                        <th scope="row"><label for="pool_opening_hours_<?php echo $day; ?>"><?php _e(ucfirst($day) . ' Opening Hours', 'pool-status-widget'); ?></label></th>
                        <td><input name="pool_opening_hours_<?php echo $day; ?>" type="text" id="pool_opening_hours_<?php echo $day; ?>" value="<?php echo esc_attr($opening_hours[$day]); ?>" class="regular-text"></td>
                    </tr>
                    <?php
                }
                ?>
            </table>
            <?php submit_button(); ?>
        </form>
    </div>
    <?php
    return ob_get_clean();
}
add_shortcode('pool_status_settings', 'pool_status_settings_shortcode');
